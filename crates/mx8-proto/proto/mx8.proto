syntax = "proto3";

package mx8.v0;

// Control-plane API between mx8d-agent (per-node) and mx8-coordinator (per-job leader).
//
// Error semantics:
// - INVALID_ARGUMENT: malformed request (missing IDs, want==0, etc.)
// - FAILED_PRECONDITION: node not registered, job not ready (membership barrier), or invalid ownership state
// - NOT_FOUND: unknown lease_id / manifest_hash
// - UNAVAILABLE: transient coordinator issues; client should retry with backoff
// - INTERNAL: unexpected server error (bug)
service Coordinator {
  rpc RegisterNode(RegisterNodeRequest) returns (RegisterNodeResponse);
  rpc Heartbeat(HeartbeatRequest) returns (HeartbeatResponse);
  rpc RequestLease(RequestLeaseRequest) returns (RequestLeaseResponse);
  rpc ReportProgress(ReportProgressRequest) returns (ReportProgressResponse);
  rpc GetManifest(GetManifestRequest) returns (GetManifestResponse);
  // Chunked manifest proxy to avoid gRPC message size limits for larger manifests.
  // Clients must concatenate chunks in order to reconstruct `manifest_bytes`.
  rpc GetManifestStream(GetManifestRequest) returns (stream ManifestChunk);
  // Read-only snapshot for local operator/TUI views.
  rpc GetJobSnapshot(GetJobSnapshotRequest) returns (GetJobSnapshotResponse);
}

message NodeCaps {
  uint32 max_fetch_concurrency = 1;
  uint32 max_decode_concurrency = 2;
  uint64 max_inflight_bytes = 3;
  uint64 max_ram_bytes = 4;
}

message RegisterNodeRequest {
  string job_id = 1;
  string node_id = 2;
  NodeCaps caps = 3;
}

message RegisterNodeResponse {
  uint32 assigned_rank = 1;
  uint32 world_size = 2;
  string manifest_hash = 3;
  uint32 heartbeat_interval_ms = 4;
  uint32 lease_ttl_ms = 5;
  uint32 registered_nodes = 6;
  bool job_ready = 7;
}

message NodeStats {
  uint64 inflight_bytes = 1;
  uint64 ram_high_water_bytes = 2;
  uint32 fetch_queue_depth = 3;
  uint32 decode_queue_depth = 4;
  uint32 pack_queue_depth = 5;
  // Optional runtime autotune/state fields (0/false when unavailable).
  bool autotune_enabled = 6;
  uint32 effective_prefetch_batches = 7;
  uint32 effective_max_queue_batches = 8;
  uint32 effective_want = 9;
  uint32 autotune_pressure_milli = 10;
  uint32 autotune_cooldown_ticks = 11;
  uint32 batch_payload_p95_over_p50_milli = 12;
  uint64 batch_jitter_slo_breaches_total = 13;
}

message HeartbeatRequest {
  string job_id = 1;
  string node_id = 2;
  uint64 unix_time_ms = 3;
  NodeStats stats = 4;
}

message HeartbeatResponse {
}

message WorkRange {
  uint64 start_id = 1;
  uint64 end_id = 2; // half-open [start_id, end_id)
  uint32 epoch = 3;
  uint64 seed = 4;
}

message Lease {
  string lease_id = 1;
  string node_id = 2;
  WorkRange range = 3;
  uint64 cursor = 4;
  uint64 expires_unix_time_ms = 5;
}

message RequestLeaseRequest {
  string job_id = 1;
  string node_id = 2;
  uint32 want = 3;
}

message RequestLeaseResponse {
  repeated Lease leases = 1;
  // When `leases` is empty and the job is ready, the coordinator may ask the agent to back off.
  // Semantics: retry after approximately this many milliseconds. 0 means "retry immediately".
  uint32 wait_ms = 2;
}

message ReportProgressRequest {
  string job_id = 1;
  string node_id = 2;
  string lease_id = 3;
  uint64 cursor = 4;
  uint64 delivered_samples = 5;
  uint64 delivered_bytes = 6;
  uint64 unix_time_ms = 7;
}

message ReportProgressResponse {
}

message GetManifestRequest {
  string job_id = 1;
  string manifest_hash = 2;
}

message GetManifestResponse {
  bytes manifest_bytes = 1;
  uint32 schema_version = 2;
}

message ManifestChunk {
  bytes data = 1;
  uint32 schema_version = 2;
}

message GetJobSnapshotRequest {
  string job_id = 1;
}

message NodeSnapshot {
  string node_id = 1;
  uint32 assigned_rank = 2;
  uint64 last_heartbeat_unix_time_ms = 3;
  NodeCaps caps = 4;
  NodeStats stats = 5;
}

message CoordinatorCounters {
  uint64 register_total = 1;
  uint64 heartbeat_total = 2;
  uint64 request_lease_total = 3;
  uint64 leases_granted_total = 4;
  uint64 leases_expired_total = 5;
  uint64 ranges_requeued_total = 6;
  uint64 progress_total = 7;
}

message GetJobSnapshotResponse {
  uint64 server_unix_time_ms = 1;
  string manifest_hash = 2;
  uint32 world_size = 3;
  uint32 registered_nodes = 4;
  bool job_ready = 5;
  bool job_drained = 6;
  uint64 active_leases = 7;
  uint64 available_ranges = 8;
  repeated NodeSnapshot nodes = 9;
  repeated Lease live_leases = 10;
  CoordinatorCounters counters = 11;
}
